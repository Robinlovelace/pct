---
title: 'The National Propensity to Cycle Tool: A generalisable flow-level model of
  cycling uptake for sustainable transport planning'
header-includes: \usepackage{amsmath}
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
  html_document:
    toc: yes
  word_document:
    fig_caption: yes
bibliography: Transport.bib
---

```{r, echo=FALSE, include=FALSE}
if(grepl(pattern = "pct$", x = getwd())){
  setwd("documents")
}
# source("../set-up.R")
pkgs <- c("stplanr", "knitr", "xtable", "sp", "grid", "png")
vapply(pkgs, require, character.only = T, FUN.VALUE = logical(1))
```


# Introduction

The National Propensity to Cycle Tool (NPCT) is
an interactive policy support application for
developing transport policies, funded by the UK's Department
for Transport (DfT). The NPCT will have data covering England
and be used by Local Authority transport planners
to prioritise investment in cycling. The tool's main purpose
is to help prioritise where to build new strategic cycle routes
and related infrastructure at the city level.

This paper describes the model underlying the
NPCT and explains some of the decisions that were made relating to
the data and methods that it uses.
The model is open source and transparent,
based on input datasets that
are widely available in many countries around the world.
The model is implemented in R, a mature language for
statistical computing. All of the code has been made available
under the MIT license on the GitHub platform.^[See [github.com/npct/pct](https://github.com/npct/pct).]

The research was funded by the UK's Department for Transport and this paper
focuses on Phase I of the work. In 'Phase II' we will extend to the model
to the entirety of England. Key lessons were learned during Phase I and,
where applicable, these are discussed in relation to future plans.
Although the original model was developed for England, the NPCT methodology
has the potential to
assist with the design of transport policy in many settings.
The present paper reports results from 3 case study or 'pilot' cities which
acted as a 'proof of concept' for the Department of Transport: Coventry,
Manchester and Norwich. The method is described in a generalisable way,
however, so it is applicable to any city or region where appropriate datasets
are available.
The 'generalisability' of the method is important due to the
momentum behind active travel in cities across the world.
Planning support tools such as the NPCT can help the
associated investment to be spent effectively, yielding more efficient
targeting of resources.

```{r, echo=FALSE}
# This transition is needed to prevent runaway
# climate change . The worldwide uptake of cycling, driven by well-placed
# infrastructure,
# 'soft' policy incentives and wider cultural shifts away from the car will also
# have enormous health benefits.
# The design of such infrastructure and policies
# can be enhanced by tools such as the
# NPCT. Given the tool's great potential for wider social benefit, it is
# vital to communicate the underlying methods and software.

# The aim of the present paper is to explain the underlying model which drives
# the scenarios used in the NPCT. This is of academic interest due to
# the increased accuracy with which the method can estimate the
# spatial distribution for cycle infrastructure. It is also of
# great policy relevance during a time of transition away from energy inefficient
# forms of transport such as the personal automobile.
```

The model operates at the flow-level and, by aggregating
data from these flows, at the level of geographic zones.
A 'flow' in this context constitutes an origin-destination pair: the place where
a trip begins and the destination where it ends. Flows therefore represent
'desire lines', typically connecting residential origins with workplace,
educational or other destinations.
The model takes the current rate of cycling and other variables per flow and uses
this to simulate what the rate of cycling per flow could be
under various future scenarios.
It is important to note that the models do not take into account specific policies,
such as a particular piece of new infrastructure (although further work could explore adding such
capability). However, the models do allow for the estimation of where new
cycling trips would be generated given specific outcomes, such as a target
level of cycling (typically measured as a proportion of all trips) being met.
The 'Cycling Delivery Plan' scenario, for example, assumes a doubling in the
level of cycling,
this being the proposed target of the Governmentâ€™s draft
Cycling Delivery Plan (DfT 2014).
The Cycling Delivery Plan scenario translates this doubling into a change
in cycling at the flow level. Specifically, the future rate of
cycling is simulated at a high level of geographical resolution: per flow line
and per small administrative zone. The model can answer the question:
if cycling increases overall by this amount nationally,
how could this plausibly come about at the local level?
More specifically: along which routes would the new 
cycle^[We
use the term 'cycle' instead of 'bicycle' to include trips made by
tricycles, quadricycles and hand cycles.] trips plausibly occur?
 
The model operates 'under the hood' in the NPCT online interface.
This means that the
output of the NPCT is simply a visualisation of the model's pre-calculated
outputs. Rather than interacting with the code that drives the model directly,
users interact with visualisations of the model output. This makes the user
interface more accessible. The user is not required to perform any of the model
set-up for the model to run, but can access all of the underlying code
through the project's online code repository.^[See
[github.com/npct/pct](https://github.com/npct/pct).]
Thus practitioners can further develop the model if they have the
skills and time to do so, for example to add new explanatory variables
specific to the local area. We plan to encourage a user community to
build up around the tool and to create new versions for specific applications
in Phase II of the project.
This could involve running training sessions for transport planners with
programming experience.

# Data

The basic model requires only two sets of input data
(although more refined versions benefit from many additional datasets):

- *Flow data* estimating the rate of movement between different places.
Ideally these datasets should include a breakdown of trips by mode of
travel, as this enables regression models.
We used flow data disagregated by mode for England, although
it would also be possible to estimate cycling potential in cases where
no break-down by mode is possible.
Flow data are available from various sources, including:
flows derived from mobile telephone service providers
[@smoreda2013spatiotemporal];
public transport data [@Kitchin2013]; household
travel surveys [@TransportforNSW2014];
and census data on home and work locations [@Rae2009].
We used Census 2011 data in the first instance due to their
comprehensive coverage of the population,
high geographic resolution and assurances surrounding
data quality. In cases where no census data are available
(e.g. in relation to shopping trips), some combination of the aforementioned
alternative sources such as those derived from mobile telephones
may be able to provide a reasonable approximation of real world travel  . 
Flow data are
generally provided as a 'flow matrix' (with rows representing origins
and columns destinations) or a longer table of origin-destination pairs.

- *Geographical data* that provide the coordinates corresponding to the trip
origins and destinations present in the flow data.
At a bare minimum, this means the centroids of each zone in the study area, preferably weighted by population and/or work location-weighted.  In addition to this, geographic variables could also include additional
features of the urban environment that affect cyclists, such as
hilliness or number of nodes on the public transport network.

The flow model described in this paper can work for
anywhere that has access to such data. To link
the two datasets together, *zone ids* are needed in both
datasets. To ease the process of combining *flow* data and geographical
*point* data,
an R function called `gFlow2Lines()` was
created.^[The source code of `gFlow2Lines()` has been made available
online, as part of an R package for sustainable transport planning,
**stplanr**. See [github.com/Robinlovelace/stplanr/](https://github.com/Robinlovelace/stplanr/blob/master/R/gFlow.R).]
Table 1, Table 2 and Fig. 1 illustrate the two input datasets along with the
single output, namely a set of geographically defined lines with attributes for
each flow in both directions (labelled flowlines).

```{r tflow, echo=FALSE, results='asis'}
t1 <- xtable(head(flow[c(1:3, 12)]), caption = "Sample of the 'flow' input dataset, representing the number of people who commute from locations within and between administrative zones (MSOAs)", label = "tbl:flow")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r tcents, echo=FALSE, results='asis'}
t2 <- xtable(as.data.frame(cents[1:3,-c(3,4)]), caption = "Sample of the 'cents' input dataset, representing the geographical location of the population-weighted centroids of MSOA zones described in Table~\\ref{tbl:flow}", label = "tbl:cents")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r, echo=FALSE, fig.cap="Illustration of 'flow data' converted into geographical lines between origin and destination pairs for Coventry. Width represents the total number of trips. Note the use of population-weighted (as opposed to geographic) centroids used for the point of departure and destination."}
# data("flowlines")
# plot(flowlines, lwd = flowlines$All / 10)
grid.raster(readPNG("../figures/coventry-centroids.png"))
```

Although the details may
differ,^[For example,
categories used to disaggregate flow
by vehicle mode, trip type and socio-demographic group will vary depending on
the data source. Flow data from some sources (e.g. anonymised mobile phone records)
will not have any categories and simply report total flow.] the basic structure
of flow data is likely to be applicable in many settings.
The model for England described in this paper uses the following open datasets:

- `wu03ew_v2.csv`, a 104 MB (12 MB compressed) comma-delimited
text file
of flows between unique origin destination pairs, disaggregated by mode (see Table 2). Note that this is a square table, which was loaded as a `data.frame`
in R. Note the origin and destination codes in some rows
are the same, indicating *intra-zone* flow, meaning trips which begin and
end in the same zone, as is the case in the top row of Table \ref{tbl:flow}.
In summary, this dataset describes the overall pattern of travel behaviour
in a region (for commuting in this case) in terms of 'desire lines' between
hundreds of geographically dispersed origins and destinations.

- `cents.geojson`, representing population-weighted centroids of local
administrative zones. For Phase I of the NPCT we used Medium Super
Output Areas (MSOAs) as both origins and destinations.
MSOAs are a geographic unit used for the release of
statistical data (average population around 7,800 people).
Other geographic levels can be used.

In Phase II of the project we plan to
explore using Lower
Super Output Areas (LSOAs, average population of around 1,600) as the
origins and Workplace Zones (WZ) as the destinations. Using different
geographic units for the origins and destinations, as planned for
Phase II, has two advantages: the centroids will is better-matched
to actual workplace destinations and the direction of travel is clearer.
The centroid data can either be extracted from
boundary data (which finds the geographic centroid) or, if available,
a population-weighted centroid dataset can be used.
England has a population-weighted centroid dataset and
this was used for the NPCT model as the aim is to model population flows.
^[The centroids were loaded in the model from
a small (1.7 MB) human-readable text file stored in the open
data format GeoJSON. This file was originally downloaded as a Shapefile
under the UK's Open Government Licence.
The license was accessed from [nationalarchives.gov.uk](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/) in
March 2015.] In summary this dataset shows the user where people live, an
important determinant of whether they will benefit from new infrastructure in
their local area.

# Method

## Loading data for local government areas

To ensure reproducibility and enable deployment of the model outside the
original case study cities, a systematic data loading method was
developed. The computational work to load the various datasets
was developed in a series of modular scripts that were subsequently
integrated into a single script: `load.Rmd`. This approach ensures that
each component of the data (e.g. flow data, administrative zones,
topography data) can be loaded separately but that there is a single 'master'
script to bring together all the diverse data 
sources.^[See
[github.com/npct/pct/tree/master/loading-data](https://github.com/npct/pct/tree/master/loading-data) for a full list of the loading scripts used for the NPCT.].
The majority of the loading scripts will only need to be run once;
for the case study cities, all open-access
datasets that were created this way were   saved in a separate folder:
[github.com/npct/pct-data](https://github.com/npct/pct-data).

It is possible to run the model for the whole England at once but as the end user is
interacting via a map this could mean overloading the user and the computer.
Therefore for pragmatic reasons we decided to divide-up England into regions at which
funding is allocated and at which planners work,
to ensure the results are compatible with previous transport plans.

Using only one regional geographic level
can also have disadvantages, for example
hindering the creation of inter-regional plans and a potentially
detrimental reduction of emphasis on 'edge zones' that straddle two
or more regions.  To overcome this issue it is worth considering
using more than one regional geography, as well as considering
running at least one version of the model at the national level.
Another solution to the problem of 'edge zones'
is to create buffers around the the regions.
We plan to test these recommendations in Phase II, and ask
practitioners for feedback on the advantages and disadvantages of each
option.

```{r, echo=FALSE}
# The wider national policy context should be considered when selecting
# the regional geographies that are appropriate for the model.
# In Phase I of the work to implement the NPCT for the UK we used LADs, then switched to CUAs after user testing.  TTWs also possible, and in the long term perhaps LEPS.  Our recommendation is to build it at the CUA level
```

In Britain, transport decisions (such as where to build new cycle routes)
are often made at the local level [@Gaffron2003]. At present, this
primarily means at the level of local Highway Authorities, which
generally have the same boundaries as County and Unitary Authorities (CUAs).
There are 152 CUAs in England (some of which are illustrated in Fig. 2).
We recommend these CUAs as the regional unit for Phase II of the
project.^[Some work is required to ensure the compatibility of pre 2011
and post 2011 codes.]

As well as CUA level an increasing proportion of transport funding in
England is also being allocated to Local Enterprise Partnerships (LEPs)
and Combined Authorities (CAs) which are larger than, and often overlapping with, CUAs.
Based on these insights, and feedback from practitioners, our
recommendation for Phase II is to build the NPCT for every CUA in
the nation and for selected LEPs and CAs where strategic
cycling plans are being planned. These plans could change based on
feedback from the Department for Transport.

We will also explore the possibility of
running the model at the national level. This would involve setting
appropriate selection criteria to filter-out the majority of
origin-destination pairs to avoid exceeding computational resources.
The demarcation of regional boundaries is deemed useful for focusing
on one region at a time.

Phase I of the NPCT project focused instead on smaller administrative units:
Local Authority Districts (LADs). There are 324 LADs across England.
For the case study towns of Manchester and Coventry, the choice between
CUA and LAD levels
made no difference as LADs and CUAs have the same boundaries for these areas.
For Norwich, however, the LAD is much smaller than the CUA and is less
practical for strategic transport planning at the MSOA level (Fig. 2).
For this reason
we implemented a buffer selection methodology to expand the scope of the
selection, as described in the next section. Before describing the
buffer selection method, it is worth briefly considering some
of the other regional geographies that could be used: Travel to Work Areas (TTWAs),
which could be applicable in many contexts and Local Enterprise Partnerships
(LEPs) which are specific to the UK context.

TTWAs are 'commuting watersheds' that correspond to
cohesive regions, the centres of which are known employment centres [@Coombes2008].
Versions of the NPCT model developed for more scientific purposes would benefit
from using TTWAs as the regional geography for local scenario development and
visualisation.

```{r cuas-lads, echo=FALSE, fig.cap="Local Authority District (LAD, above) and County and Unitary Authority (CUA, below) levels of transport planning. These are potential regional units for the National Propensity to Cycle Tool"}
grid.raster(readPNG("../figures/cuas-las.png"))
```

## Variable zone and flowline selection criteria

Flow-routes are where the origin-destination pair is mapped onto the current
travel network using the fastest cycling route possible.
Flow-routes are used in the model but calculating them for
the travel routes possible between all origin-destination pairs
requires significant computational resources.
For our NPCT Phase I model, the route allocation algorithm, implemented 'in the
cloud' by CycleStreets.net (an online routing service for
planning cycle trips),
is the major bottle-neck at present in terms of
computational time.  In order to make the model scalable and flexible,
it may be desirable that only a sub-sample of flow-lines should be processed
within the model. 
We therefore sought to reduce the number of flows whilst retaining the overall
travel pattern. The most straightforward way to do this is to only include
flows that are used by a minimum number of commuters. Because
the distribution of number of commuters per flow is highly
skewed by high numbers of commuters using a few major 'commuter corridors',
a high proportion of commuters can be represented by
a relatively small proportion of flow lines. In Manchester,
for example, 15% of flow lines (those used by 30+ commuters)
account for almost 70% of commuters. The number 30 is a parameter that
can be adjusted to reach a reasonable balance between
comprehensive coverage on the one hand and being fast to save and load on the other.
Setting the maximum Euclidean distance is another way to reduce the number of
flow lines, and this can be done in conjunction with setting a maximum number of commuters. We used a maximum value of 15 km Euclidean distance,
based on the knowledge that this typically translates to a road distance
of over 20km. This distance is not feasible for most people to cycle on a daily basis. A related issue is the selection of flow lines to illustrate.
At present the tool select all lines completely encapsulated in the current
zoom extent. Future work could explore allowing alternative ways of
selecting lines, such as via polygons of origins, destinations, or both.

Although flow-lines are the unit of analysis for running the model,
zones are the basic unit of visualisation of the results over geographic space.
This is largely because the number of flow-lines processed in the model is
such that they cannot all be effectively visualised on a single map.
It is very hard to interpret a map showing more than around 50 flow-lines
simultaneously.  Zones solve this problem, by averaging results across a surface.

In our model testing, we found that there often seemed to be too few 'MSOA'
zones per Local Authority 'LAD' region to gain a comprehensive understanding
of the travel system. This would be solved by using larger regional units to
split the MSOAs into groups for visualisation, as planned for Phase II.
An alternative is to create buffers around each region,
from which additional sampled additional
zones are sampled. This sampling of additional zones within a buffer
could be triggered if the number of zones falls below some threshold.
We set this threshold to 60 for Manchester (which contains 57 MSOAs) so that
zones would be selected outside the long and thin LAD shape. 
This protocol increases the sample size by including all
zones whose population-weighted centroid lies inside the
buffer.  

This led to the selection of additional zones
outside Manchester's long and thin LAD shape.
Implementing this procedure involved creating a
parameter, `buff_dist`, which represents the distance buffer around the LAD in
question from which the additional zones are sampled.  This approach has the
additional advantage of preventing breaks in continuity (and zero flows)
between different regions in the model.

## The Model Output tab

Users can view a summary of the model, including the subsetting
criteria mentioned above, without going through all the
underlying code. This is can be done via the 'Model Output' tab (Fig. 3).
This feature of the user interface serves three purposes: 
to avoid 'hiding' the underlying model from users; to encourage modifications
and enhancements to the code; and to ensure transparency.
The tab was added in response to feedback during the user
testing sessions, during which a number of transport
planners had requested further information about the model.
The output tab also communicates the results of the model, including through key statistics, diagnostic plots and model-results on a per-region
basis. This means that a different summary document is provided depending on
which local authority the user is currently exploring. 
The complete model output document for Manchester is provided in Appendix X.

```{r, echo=FALSE, fig.cap="The Output Tab of the National Propensity to Cycle Tool"}
grid.raster(readPNG("../figures/model-outpute.png"))
```


```{r, echo=FALSE}
# Some of the outputs of
# the Model Output tab are illustrated in Fig. xx to Fig. xx below.
```

## Modelling distance decay

So far we have described the input data and ways of processing, selecting and
subsetting different geographical objects (primarily lines, representing
flows and polygons, representing administrative zones) for the NPCT. Yet the
greatest value of the NPCT lies in its ability to represent different
scenarios of the future. Illustrations of how the number of cyclists using
different 'desire lines' along each flow could shift in the future were
described as 'very useful' for transport planning during user testing.
In addition, the visualisation of different scenarios of the future enables
'visioning', an activity that has great potential in transport planning
[@Tight2011].

For all scenarios (except *gender equality*) a regression model was used
to estimate the potential rate of cycling at the flow level. Place of
home and work are geographical variables with a high degree of inertia,
so we assumed these would remain constant under all scenarios.
An exciting future direction of this research would involve
shift work and home locations, for example to reflect a more localised
economy. This could provide insight into the impact of changing
travel demand patterns on the potential rate of active travel in
different areas. This section describes the regression model
and how it was used to generate geographically-specific scenarios
of transport futures.

The regression model operates at the *flow* level and
seeks to explain the current level of cycling.
It does so using Ordinary Least Squares (OLS) to 
optimize a number of model parameters
linking the *explanatory variables* described above to the *dependent variable*:
the proportion of trips made by cycling per flow ($pcycle$). Central to the
model is *distance decay*, which describes the (non-linear) relationship
between the distance of a trip and the probability of it being made by cycling.
After trying various functional forms on various flow datasets,
we found that the distance decay
curve displayed in Fig. 4, and variations thereof,
seemed to fit the data well. 

```{r, echo=FALSE, fig.cap="The distance decay curve resulting from the log-square-root function. The green lines represent increases of 0.25 times original parameter values (obtained by running the model on data from the 2011 Census for Manchester) and the red lines represent -0.1 times the original value."}
grid.raster(readPNG("../figures/log-sqrt-params.png"))
```

The gradual decline of
$pcycle$ with increasing distance results in a 'long tail' distribution,
typical of exponential decay. Thus we estimated
the $log$ of $pcycle$ rather than $pcycle$ directly. Also, to avoid
estimates that are above 1 or below zero, we applied a *logit link*
to the model to improve model fit. Including hilliness as a 
dependent variable, the final model formula was as follows:

$$
log(pcycle) \approx \alpha + \beta_1 X1 + \beta_2 X1 + \theta X2
$$

where $X1$ is distance (km, route distance) and
$X2$ is the hilliness (described below) per flow.
$\alpha$ represents the intercept (the rate of cycling very short
trips), $beta_1$ and $\beta_3$ represent the rate of distance decay
and $\theta$ represents the impact of hilliness on cycling.


# Model scenarios

Once the input data has been processed and sub-setted to the area of interest,
it is passed to a regression model. The dependent variable is the 
percentage of trips currently made by cycling (*pcycle*).
This is calculated as the
number of cycle commutes from the flow data (*OLC*) divided by the
total flow by all modes per flow ($tflow$).
In the model output, this is visualised as number of cyclists.

The explanatory variables predicting the percentage of trips made by cycling
included the route distance of each flow and hilliness. By aggregating the
origins of all flows, the model
also estimates the proportion of commuters cycling to work among inhabitants in
each area. (Aggregating by destination would also allow an estimate of the
number incoming cyclists per work destination, which would be useful for
assessing features such as new cycling parking.) In descending order of
importance (in the UK context), the factors implemented in NPCT in Phase I were:

- Distance between origins and destinations. This was calculated in the first
instance as Euclidean (straight line) distance for filtering purposes using
the **rgeos** package.
An estimate of route distance was then assigned to each flow
using the CycleStreets.net
API.^[To implement this functionality in a generalisable way
a custom function, `route_cyclestreet()`, was
written for the R package **stplanr**.]

- Hilliness of zones and routes.
Hilliness is a continuous variable in our model designed to capture the extent
to which vertical gradient along cycled routes is a disincentive to cycling.
There are various ways to represent this information, ranging from the simple
(e.g. the vertical displacement between origin and destination) to the
complex (e.g. total amount of climb along the route network in both directions).
In Phase I we started with a simple approach to demonstrate the importance of
hilliness. This involved converting open digital elevation model (DEM)
data from NASA into a measure of gradient and then aggregating this to
the level of administrative
zones.^[The
average gradient of the administrative zones was
data from the Shuttle Radar Topography Mission (SRTM), collected by the National Aeronautics and Space Administration (NASA) and provided for public download by the Consultative Group on International Agricultural Research (CGIAR - see http://srtm.csi.cgiar.org/). "Version 4" of the dataset was used. At the equator, this has a resolution of 90m. Across the UK, the average resolution of the raster, converted to the OSGB1936 Coordinate Reference System (CRS) is 56.5 m along the east-west axis 92.6 m along the north-south axis. To convert the elevation data into a gradient in degrees for each raster cell the function 'terrain' from R's 'raster' package was used which implements the algorithm of Horn (1981). To geographically aggregate these values to find the average gradient per LSOA zone the function 'extract' was used, also from the raster package.]
To allocate this area-based hilliness metric to flows, we calculated the average
hilliness of origin and destination. This method has the disadvantage that it
becomes far less accurate for longer journeys spanning many intermediate zones
and is also less accurate for origin or destination zones with considerable
internal variation in hilliness. We therefore plan to refine this method in
Phase II.

For Phase II we will explore using additional explanatory variables to predict
cycling more accurately and to differentiate more finely between different types
of area. We have data on the following variables and the impact of each on model
fit will be explored (we will also explore additional variables for which we do
not yet have data in a suitable form for the model such as weather):

```{r, echo=FALSE}
# - Gender balance. The remit for including this variable is that the male:female
# ratio of cycle commuters is around 3:1 in the
# UK;^[The mean proportion of males cycling to work from the 2011 census
# across Local Authorities
# in England is 0.77. This corresponds to a ratio of 3.3:1.]
# thus including the
# proportion of short (5km and less) trips made by females can
# greatly improve model fit. Note that this variable was used at the areal
# unit level (per zone, as opposed to per origin-destination pair) due to
# data limitations. Critically, this variable can be used as the basis of
# scenarios estimating the impact of a 'gender equality' scenario for cycling
# increase at the local level.

# - Age.
```

```{r, echo=FALSE}
# - Gender. There is evidence that women are more put-off cycling
# by poor transport infrastructure and heavy traffic than men, so this could be
# linked to a measure of transport infrastructure quality.
```

- Weather. It rains in some places more than others and there is evidence
to suggest that this is a deterrent to cycling. This could be included with
reference to interpolated rasters of estimated rainfall.

- Age/occupational status. There is evidence that much of the uptake
in cycling in some
areas has been due to students and other mobile groups taking up cycling
when they move away from home. This could represented in the model as
% of students or % of people between 16 and 30 in each area.

- Infrastructure quality. Preliminary tests with the commuting data suggest that
having a direct off-road path along the flow line is a strong predictor of the
rate of cycling. This can be quantified in various ways, for example
via the 'quietness diversion factor' ($qdf$), the ratio
between the 'quietest' and the 'fastest' route calculated by CycleStreets.net ($qdf = d_{fast} / d_{quiet}$).
The inclusion of this variable per flow creates an opportunity
to estimate the short-term impacts of new or improved cycle provision.
By setting $qdf$ to 1 (i.e. setting $d_{quiet} = d_{fast}$), the
increase in the number of cyclists using upgraded routes can be estimated.
An example in which the length of a quiet route is much further than
the fastest route (i.e. $qdf > 1.2$) is provided at the end of this
paper, in Fig. 9. Note that $qdf$ is different than
cirquity ($q$), the diversion
from straightline (Euclidean) distance as it approximates
represents *how much further* one must travel to use a quiet path.
Where $qdf$ is low, this means that the quiet routes are also the
most direct, which will likely encourage new cyclists.

Note that *total number of cycle trips* is not an explanatory variable on
its own. This is because
the dependent variable includes cycling by using
the *proportion* of those who cycle. This measure, labelled $pcycle$,
is robust to large variations in the absolute flow by all modes.

```{r, echo=FALSE}
# ## Baseline
#
# The baseline scenario (*baseline*)
```

## Cycling Delivery Plan

The Cycling Delivery Plan scenario (*cdp*) is based on the government's
proposed target to double cycling in England, from 0.8 billion stages currently to
1.6 billion stages by 2025 [@DepartmentforTransport2014].
Assuming increases in population offset
the national trend towards lower trip
rates,^[Increases
in population would mean the *proportion* of trips by cycle
would not need to double for the *absolute number* of trips to double.
However, the rate of trips overall (measured in the number of trips
per person per year by any mode for any purpose) is on a long-term
downward trajectory which more than offsets the impact of population
growth. See
[@Crawford2014] for a detailed discussion of this issue.
The authors could not find evidence about how this trend was
accounted for by the DfT in scenarios from the National Transport
Model (NTM) or elsewhere.]
achieving the draft Cycling Delivery Plan's proposed target would
result in a doubling in the
proportion of trips made by cycling nationwide.
@DepartmentforTransport2014 provide no discussion or breakdown in the geographic
distribution of potential cycling uptake in their publication of the scenario, and so we made our own
assumptions about this (see next paragraph). The *cdp* scenario should help
transport planners identify where new demand for cycling is likely to be greatest.

In line with the target set out in the draft Cycling Delivery Plan, the *cdp* scenario
seeks to approximate the geographic distribution of growth in cycling
under a scenario of doubling in cycling. In our implementation of this
scenario, cycling does not double in all areas. Places that have high average
commute distances or that already have a rate of cycling above the national
average will see cycling increase less than two-fold; areas with a below average
current rate of cycling but high potential based on the number of short commute
trips will see cycling increase more than two-fold. The same logic applies to
flows: origin-destination pairs that are close together but with a currently low
rate of cycling tend to see the greatest increase in cycling under the *cdp* scenario.

```{r, echo=FALSE}
# Old description of cdp
# The *cdp* scenario also relates to the *distribution* of trips
# in the study area compared with the data used for the model.
# If the distribution of
# all trips in the regression model
# is flatter than the distribution of cycling trips in the study area,
# a doubling in
# propensity will not lead to a doubling in cycling. If, on the other hand,
# the distribution of cycling trips in the study area mirrors high
# volume flows for which cycling is currently rare,  a doubling in propensity
# will more-than-double the rate of cycling. If the study flows are the same
# as the data used to train the model, *cdp* always results in a doubling in
# cycling. These concepts are illustrated in
# Fig. x below.


# ```{r, echo=FALSE, warning=FALSE, fig.cap="The rate of cycling under the cdp scenario for a case study Local Authority (Coventry). OLC is represented in blue, SLC(cdp) is represented by the white lines."}
# l <- readRDS("../pct-data/coventry/l.Rds")
# flow <- l@data
# mod_logsqr <- glm(clc ~ dist + I(dist^0.5), data = flow, weights = All, family = "quasipoisson")
# flow$fitted <- mod_logsqr$fitted.values * flow$All
# coefs <- coef(mod_logsqr)
# ff <- stplanr::dd_logsqrt(x = flow$dist, a = exp(coefs[1]), b1 = coefs[2], b2 = coefs[3])
# # plot(ff, mod_logsqr$fitted.values) # perfect fit - function works
# flow$cdp <- ff * 2 * flow$All
#
# l2 <- rep(l$dist, l$All)
# l3 <- rep(l$dist, l$Bicycle)
# l4 <- rep(flow$dist, flow$cdp)
# # hist(l2)
# p2 <- ggplot() + geom_histogram(aes(l2), binwidth = 0.5) +
#   geom_histogram(aes(l3), binwidth = 0.5, fill = "blue") +
#   geom_histogram(aes(l4), binwidth = 0.5, col = "white", fill = NA, linewidth = 5) +
#   scale_y_log10() + xlab("Distance (km)")
#
# p1 <- ggplot() + geom_histogram(aes(l2), binwidth = 0.5) +
#   geom_histogram(aes(l3), binwidth = 0.5, fill = "blue") +
#   geom_histogram(aes(l4), binwidth = 0.5, col = "white", fill = NA, linewidth = 5) + coord_cartesian(ylim = c(0, 2000)) + xlab("Distance (km)")
#
# library(gridExtra)
# grid.arrange(p1, p2)
# ```
```

At the heart of the *cdp* scenario is a regression model at
the national level (labelled $natmod$) estimating 
the current proportion of trips by cycle by (*pcycle*).
Route distance and hilliness at the national level were the explanatory variables
in Phase I, although as explained above additional variables could easily added.
The resulting national
distance decay curve is then applied locally. The additional number of cyclists
for each flow is calculated by multiplying the proportion expected for the
distance of the flow nationally. 
The new rate of cycling ($pcycle(cdp)$) is the current rate of
cycling plus this model-based estimate:

$$
pcycle(cdp) = (pcycle + pcycle(natmod)) 
$$

where $pcycle$ is the proportion of commuters who cycle per flow
in the 2011 Census and $pcycle(natmod)$ is the proportion of commuters expected to
cycle based on the national-level regression model.
The sum of these values
is multiplied by $tflow$, the total number of commuters all modes,
to convert the proportion into
a number of cyclists, i.e.:

$$
SLC(cdp) = (pcycle + pcycle(natmod)) * tflow
$$

An example of this scenario for illustrative purposes is as follows.
Based on a representative sample of flows in the UK,
among those making trips with a 'fastest route' distance of between 4 and 5 km,
the proportion who used a cycle as their main mode is 5.0%.
Under the 'national doubling' assumption of the *cdp* scenario, this
implies that the total increase in the proportion of cyclists in this distance band is 5.0% --- i.e. $pcycle(natmod) = 0.05$.
In the case study city of Manchester, the proportion of commuters
travelling 4 to 5 km to work,
who used a cycle as their main mode, was 4.6% ($pcycle = 4.6$).

All else being equal (specifically, assuming average hilliness in
Manchester is equal to the national average), the number percent of
commuters cycling to work in this case under the Cycling Delivery Plan 
scenario ($SLC(cdp)$) would be 4.6% + 5.0% = 9.6%.
The total number of commuters cycling to work in Manchester
($SLC(cdp)$) would thus be 9.6% multiplied by $tflow$,
i.e. the proportion cycling multiplied by the total number of commuters.

Note that this does not mean
that *all* flows in Manchester between 4 and 5 km would be projected to have
a 9.6% proportion of cycle commuters in the *cdp* scenario.
The initial level of cycling
(*pcycle*) will vary widely: a flow with an exceptionally high initial rate
of cycling, for example $pcycle$ = 30%, would end up with a projected
rate of cycling of 35% ($pcycle(cdp)$ = 35%). Likewise, a flow of
4.5 km that has no cycling currently would be projected to reach 5%.

## Gender equality

The Gender Equality scenario (*gendereq*) is a relatively simple modification of
an existing scenario. For the purposes of explanation, we will
use the *observed level of cycling* (*OLC*) in the 2011 Census
as the basis of the
scenario. However, it is possible to apply the *gendereq* method to
any scenario, as described towards the end of this section.

The Cycling Delivery Plan scenario
(*cdp*) makes no assumption about the future
gender split in cycling
(typically, around 3/4 of cycle commuters
are male, although this varies over geographic space).
*gendereq*, by contrast, is based on the assumption that
gender equality is reached in cycling. 
Specifically, the scenario assumes that in each flow the proportion
of females cycling is the same as the proportion of males. 
A prerequisite is a model-based estimate of the number of male
and female cyclists between origin and destinations for the baseline scenario.
This involves splitting the number of cyclists project by the model,
the *Scenario-based Level of Cycling*, into
male ($SLC_m$) and female ($SLC_f$) components:

$$
SLC = SLC_m + SLC_f
$$

More males cycle than females in every Local Authority in the country
(Fig. 5). For this reason, the *gendereq* scenario
is based on the assumption that the rate of cycling amongst
females increases to match the rate of cycling amongst males, rather than vice
versa. Under *gendereq* $SLC_m$ remains constant. The challenge is to
find the value of $SLC_f$ such that the proportion of
females cycling under the gender equity scenario ('$pcycle(gendereq)_f$')
becomes equal to the observed proportion of males cycling ($pmale_{cyclist}$).
Note that this is not as simple as $SLC_f = SLC_m$,
as the absolute number of female and male cyclists will also depend on the gender split of the total commuting population within each flow.^[To
illustrate this point, consider a flow in which the total number of female
commuters is larger than the total number of male commuters.
In this case, the number of female cyclists would exceed the
number of male cyclists in the *gendereq* scenario.
]
It is the *proportion* of males and females
per flow who cycle that becomes equal, as follows.

$$
pcycle(gendereq)_f = pcycle_{m}
$$

$$
\frac{SLC(gendereq)_f}{tflow_f} = \frac{OLC_m}{tflow_m}
$$

$$
SLC(gendereq)_f = tflow_f * \frac{OLC_m}{tflow_m}
$$

$OLC_m$ is the observed number of males cycling
(in the 2011 Census in this case),
$SLC(gendereq)_f$ is number of females cycling in the gender equality scenario, and
$tflow_m$ and $tflow_f$ are the total numbers of males
and females in the flow respectively.

$tflow_m$ and $tflow_f$  are both available at the flow level in the 2011 Census,
as is the total number of cyclists ($OLC$).  The proportion of cyclists who are male
in each flow ($pmale_(cyclist)$) is not, however, available in the published 2011 datasets
(although we intend to commission such tables for Phase II).
The smallest level at which the gender breakdown of cyclists is currently available
is the zone level ('$pmale_{cyclist}(zone)$'), and we assume that all flows have
this same proportion of male cyclists. This allows the estimation
the number of males cycling as $OLC_m = OLC * pmale_{cyclist}(zone)$, so that 

$$
SLC(gendereq)_f = OLC * pmale_{cyclist}(zone) *  \frac{tflow_f}{tflow_m} 
$$

and therefore the total flow for gender equality $SLC(gendereq)$ would be

$$
SLC(gendereq) = OLC_m + SLC(gendereq)_f
$$

$$
SLC(gendereq) = OLC * pmale_{cyclist}(zone) * (1 + \frac{tflow_f}{tflow_m})
$$

```{r, echo=FALSE, fig.cap="Cycling and the gender balance of cycling in England. The choropleth maps illustrate the spatial distribution of the two variables. The scatter plot illustrates the relationship between the two variables cycle commuting (x axis) against the proportion of commuter cyclists who are male (y axis) for all 326 Local Authorities (including Districts) in the UK."}
grid.raster(readPNG("../figures/las-gender-pcycle.png"))
```

To illustrate how this method works in practice, imagine a flow in which
5 from a total of 50 people commute by cycle ($tflow = 50; OLC = 5$).
30 of the total trips in the flow are made by males
($tflow_m = 30$) and 20 by females ($tflow_f = 20$).
In addition, 70% of commuter cycling in the wider zone is by
males ($pmale_{cyclist}(zone) = 0.70$). This means that
an estimated $5 * 0.70 = 3.5$ cycle commuters are male ($OLC_m = 3.5$) and 
1.5 are female ($OLC_f = 1.5$).
These are not whole numbers but represent the average
number expected in many flows with the same characteristics.

Applying the formulae presented on the previous page:

$$
SLC(gendereq)_f = OLC * pmale_{cyclists}zone * (1 + \frac{tflow_f}{tflow_m})
$$

$$
SLC(gendereq) = 5 * 0.70 * (1 + \frac{20}{30} ) = 5.83
$$

```{r, echo=FALSE}
tflow <- 50
olc <- 5 #  the currect rate of cycling between origin (o) and destination (d)
tflow_m <- 0.6 # the proportion of all trips o and d by males
pcyclez_m <- 0.75 # the proportion of cycle trips in the zone/region made by males
tflow_m <- tflow * tflow_m
tflow_f <- tflow * (1 - tflow_m)
olc_m <- olc * pcyclez_m
olc_f <- olc - olc_m
pmale_c <- olc_m / tflow_m
slc_gendereq_f <- tflow_f * pmale_c
# print(olc_f)
# print(slc_gendereq_f)
```

The increase from 5 cyclists to 5.83 represents an increase
of 17% from the observed rate of cycling
in total numbers of cyclists.  All of these extra 0.83
cyclists are female, giving a new total of 1.5 + 0.83 = 2.33 female cyclists 
(and still 3.5 male cyclists).
Gender equality in cycling has been reached, such that an estimated 11.7
% of commute trips are made by cycling among both men (3.5/30)
and women (2.33 / 20).
Note that that $SLC(gendereq)$ can be calculated based on any scenario.
In our model, instead of using the conservative *baseline* scenario,
we estimate $SLC(gendereq)$ based on the Cycling Delivery Plan
($cdp$) scenario because we are trying to represent an increase in 
cycling with a concurrent increase in gender equity.

## Go Dutch

The 'Go Dutch' scenario represents the rate of cycling that would occur if
people cycled as much as the Dutch do, for trips of the same length. It is
important to note that this is not a 'top down' scenario in which the national
level of cycling is set to levels found in The Netherlands. The scenario is
'bottom up' because the proportion of trips being cycled is set per flow
and the end result for any particular region depends on the local distribution
of trip distances.
Although the Dutch currently cycle far more frequently than the
English for short trips, their propensity to cycle still drops rapidly with
distance, with relatively few utility trips being made beyond around 15 km.

Based on these insights, the essence of the 'Go Dutch' scenario
(henceforth simply *dutch*) is the application of distance decay parameters
found in the Netherlands to each flow in the study area.
In Phase II we plan to refine this by also factoring in average differences in hilliness levels between England and the Netherlands, drawing on the work presented in Appendix XXpropensity.

## Electric cycles

The purpose of this scenario is to demonstrate the increased rate of cycling
that is possible due the electric cycles (hence the scenario name, *ebike*).
This is the most ambitious of the scenarios presented in this paper and it
builds on 'Go Dutch', with Dutch model parameters. 

In Phase I this scenario is not fully implemented, and the
results are merely illustrative.  At present, the results are
based on the decision to increase by a small amount the $\beta_1$ distance decay parameter,
that corresponds to distance as a linear term.
Specifically, we increased this value by 0.025, as we found
this to be sufficiently small to avoid generating an
implausibly high rate of cycling but sufficiently large to create a noticeable effect. 
This allows us to illustrate the type of output that will
be possible in this model. In Phase II we will implement the
model fully by basing the changes to the distance decay
parameters on real data from the Dutch National Travel Survey.

# Results

To demonstrate
how the scenarios work in practice and to provide an overview of the results,
Fig. 6 illustrates the observed level of cycling
($OLC$, from the
2011 Census) and the scenario-based level of cycling
in two Local Authorities (Manchester and Norwich). Note that while Manchester
has a much higher total number of trips than Norwich, the proportion of those
trips that are made by cycling is lower. There is noticeable distance decay
of for all modes of transport, especially for cycle trips in Norwich,
where cycle trips above 7.5 km observed from 2011 census data are
comparatively rare.

Note that although Manchester and Norwich have very
different initial levels of cycling, the final level estimated from the
*dutch* and *ebike* scenarios are similar, reflecting local trip distributions
and overriding the initial rate of cycling. Note also that the *cdp* scenario
in Manchester has a considerably higher rate of cycling than the *gendereq*
scenario, whereas in Norwich these scenarios are very similar. This is because
Manchester is starting from a lower baseline, so a doubling nationwide
results in a relatively high absolute increase in cycling locally. In Norwich,
by contrast, the current rate of cycling is considerably greater than the
national average, so the *cdp* scenario represents less than a doubling in
cycling.

```{r, echo=FALSE, fig.cap="Results of observed and scenario-based levels of cycling from NPCT model runs for Manchester (left) and Norwich (right)."}
grid.raster(readPNG("../figures/man-nor-output.png"))
```

The difference between the spatial distribution in cycling potential between
the shorter-term Cycling Delivery Plan (*cdp*) and longer-term Go Dutch
(*dutch*) scenarios is illustrated in Fig. 7. Note that the top 20 flows
in Norwich under *cdp* assumptions is dominated by the current rate of cycling,
whereas under *dutch* assumptions, the distribution shifts to flows that
are more representative of short-distance flows in across the city overall.
In both cases the flows are focused around Norwich city centre: the region
has a mono-centric regional economy, making trips beyond around 5 km from the
centre much less likely to be made by cycling.

```{r, echo=FALSE, fig.cap="Model output illustrating the top 20 most cycled flows in Norwich under Cycling Delivery Plan and Go Dutch scenarios."}
grid.raster(readPNG("../figures/nor-cdp-dutch.png"))
```

The equivalent results are shown for Manchester in Fig. 8. This shows that
Manchester has a poly-centric structure, favouring the construction of cycle
routes between the various sub-centres, not just in radial routes to a single
centre. Note in both scenarios the large increase in the level of cycling in
between *cdp* (which represents only a doubling nationwide) and *dutch*
scenarios (which represents a more ambitious plan for cycling uptake).

```{r, echo=FALSE, fig.cap="Model output illustrating the top 20 most cycled flows in Manchester under Cycling Delivery Plan and Go Dutch scenarios."}
grid.raster(readPNG("../figures/man-cdp-dutch.png"))
```

To illustrate the importance of the difference between the 'fastest' and
'quietest' routes calculated by CycleStreets.net for our model, Fig. 9
illustrates the route with the highest cycling potential under the
*cdp* scenario. The 'quietest' route is substantially further, with a
distance of 2.8 km (as shown by clicking on the line). The 'fastest'
route is more direct (with a route distance of 2.3 km) but it passes
along Trinity Way (the A6042), a busy dual carriage way.
Dutch evidence suggests that cyclists will not divert to a route which
is more than about 1.4 to 1.5 times the length of the
'crow-flies' Euclidean distance (defined as $q$ above),
and that the target "for cycle provision should be 1.2".^[Reference: 'Design manual for bicycle traffic', CROW, 2007.]
This suggests that new cycle infrastructure along the Trinity Way route
would be much better used by commuters than an
alternative quiet route that diverges greatly from the shortest path.

```{r, echo=FALSE, fig.cap="Close-up of the 'fastest' and 'quietest' routes from CycleStreets.net of the flow with highest cycling potential under the *cdp* scenario in Manchester."}
grid.raster(readPNG("../figures/fast-quiet-man.png"))
```


# Discussion

The flexibility of the approach outlined in this paper ensures that it
can be used in many different contexts. Because the underlying
methods and computer code are transparent and open source, it is
possible to use the NPCT as a foundation for further work. This flexibility
has been demonstrated by the tool's ability to be deployed in any
Local Authority (or other administrative area)
in England for a range of cycling scenarios, with
wide-ranging results that can be presented in many ways.
The results demonstrate the utility of the tool for the cost-effective
allocation of investment and local targeting of policies within
a single country or region. Potential applications go far
beyond re-running the model for different cities in the same country.
Potential extensions of the model include:

- Deployment of the tool and underlying flow model in different
countries. This would depend on having appropriate flow data. As indicated
above, the datasets required for the NPCT are increasingly available, from
a range of sources.

- Inter-regional and international comparisons of model results. This could
help answer long-standing questions such as: "do areas with the highest
cycling potential receive the greatest amount of cycling investment?" and
"is there a strong link between a country's propensity to cycle and actual
rates of cycling?"

- The extension of the model to cover different trip types and demographic
groups to enable more targetted cycling policies. This could include the
addition of an 'education layer', based on the location of schools and data
on travel to school patterns, informing the construction of a network of an
off-road 'cycle to school' network.

- The extension of the tool to enable the estimation of cycling demand
following new developments, such as high-density housing or a new
school.

Because the model is open source, others are free to take the tool and
modify it for their own needs. We will actively encourage practitioners
to modify the scenarios, input data and display of the results to suit
local contexts. This could help to visualise city-level targets for
the proportion cycling by a certain year, for example,
which will vary considerably from place to place.
It is hoped that an active user community will build up around the tool.
This could enable transport planners to decide on and create
the precise set of online tools that are
that are most useful for their work.

It is likely that future work will focus on enabling
practitioners to add
new features that have not been considered in this paper.
After all, the people who best understand the
requirements of transport planners (and other users of the tool), are the
'end users' themselves. By reducing the barriers to entry into the
creation and visualisation of evidence-based scenarios about change in travel
behaviour, the NPCT methodology can empower transport decision-makers across
England and beyond to
supplement their own understandings of where need for new infrastructure is
greatest. The increased cost-effectiveness of policies that the NPCT enables
will also help to build business cases for further investment and policy change,
critical for a transition away from the private car and towards active travel.

```{r, echo=FALSE}
# # Using the tool
# 
# This Appendix summarises the work from the perspective of practitioners
# by describing how the NPCT may be used to inform the decision-making process.
```

# References

```{r, echo=FALSE, eval=FALSE}
file.copy("~/Documents/Transport.bib", "documents/Transport.bib", overwrite = T)
# this fails
# system("bibtool -x documents/flow-model.aux -o ~/Documents/Transport.bib")

file.copy("documents/flow-model.docx", "~/Dropbox/DfT bid/Draft Writeups/Robin/flow-model.docx", overwrite = T)
file.copy("documents/flow-model.pdf", "~/Dropbox/DfT bid/Draft Writeups/Robin/flow-model.pdf", overwrite = T)

```

