---
title: Where to build bike paths? A generalisable flow-level model of cycling uptake
  for sustainable transport planning
author: "Robin Lovelace"
date: "April 12, 2015"
output:
  word_document: default
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
bibliography: ~/Documents/Transport.bib
---

```{r, echo=FALSE, include=FALSE}
source("../set-up.R")
pkgs <- c("stplanr", "knitr", "xtable", "sp", "grid", "png")
vapply(pkgs, require, character.only = T, FUN.VALUE = logical(1))
```


# Introduction

# Data

The basic model requires only two sets of input data
(although more refined versions benefit from many additional datasets):

- *Flow data* estimating the rate of movement between different places.
This data is available from various sources including
flows derived from mobile telephone service providers
[@smoreda2013spatiotemporal], Census data on commuting [@Rae2009],
public transport data [@Kitchin2013], as well as the traditional household
travel survey [@TransportforNSW2014]. Some combination of these sources
will provide the data for all trip purposes and for most settings. Flow data is
generally provided as a 'flow matrix' (with rows representing origins
and columns destinations) or a longer table of origin-destination pairs.

- *Geographical data* on the coordinates of trip origins and destinations.
As a bare minimum, this means the (preferably population and/or
work location-weighted) centroids of each zone in the study area, but could
also include mobile telephone masts or nodes on the public transport network.

The flow model described in this paper can work for
anywhere that has access to such data. To link
the two datasets together, *zone ids* are needed in both
datasets. To ease the process of combining *flow* and *point* data,
an R function called `gFlow2Lines()` was 
created.^[The source code of `gFlow2Lines()` has been made available
on-line, as part of an R package for sustainable transport planning,
**stplanr**. See [github.com/Robinlovelace/stplanr/](https://github.com/Robinlovelace/stplanr/blob/master/R/gFlow.R).]
The two input datasets and single output, a set of geographically defined
lines with attributes for each flow in both directions
(which we label `flowlines`) are illustrated in the tables (1 and 2)
and figure (1) below.

```{r tflow, echo=FALSE, results='asis'}
t1 <- xtable(head(flow[c(1:3, 12)]), caption = "Sample of the 'flow' input dataset, representing the number of people who commute from locations within and between administrative zones (MSOAs)", label = "tbl:flow")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r tcents, echo=FALSE, results='asis'}
t2 <- xtable(as.data.frame(cents[1:3,-c(3,4)]), caption = "Sample of the 'cents' input dataset, representing the geographical location of the population-weighted centroids of MSOA zones described in Table~\\ref{tbl:flow}", label = "tbl:cents")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r, echo=FALSE, fig.cap="Illustration of 'flow data' converted into geographical lines between origin and destination pairs. Width represents the total number of trips. Note the circles, which represent intra-zone flow."}
data("flowlines")
plot(flowlines, lwd = flowlines$All / 10)
```

Although the details may
differ,^[For example,
categories used to disaggregate flow
by vehicle mode, trip type and socio-demographic group will vary depending on
the data source. Flow data from some sources (e.g. anonymised mobile phone records)
will not have any categories and simply report
total flow.] the basic structure
of flow data is likely to be applicable in many settings.
The model for England described in this paper uses the following open datasets:

- `wu03ew_v2.csv`, a 104 MB (12 MB compressed) comma-delimited
(human readable text) file
of flows between unique origin destination pairs, disaggregated by mode (see Table \ref{tbl:flow}). Note that this is a square table, usually loaded as a `data.frame`
in R. Note the origin and destination codes in the top row of table \ref{tbl:flow}
are the same, indicating *intra-zone* flow.
- `cents.geojson`, representing populations-weighted centroids of local
administrative zones (MSOAs). These are loaded in the model from
a small (1.7 MB) human-readable text file stored in the open
data format GeoJSON. This file was originally downloaded as a Shapefile
under the UK's Open Government Licence.^[The license was accessed from http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/ in
March 2015.]

## Loading data for local government areas

To ensure reproducibility and enable deployment of the model outside the
original case study area of Manchester, a systematic data loading method was
developed. The computational work to load the various datasets is contained
in the folder `loading-data` in the project's central repository.^[See https://github.com/npct/pct/tree/master/loading-data]. 
In the UK, local transport decisions (such as the location of new cycle paths)
are often made at the Local Authority level [@Gaffron2003].
 some work to debug the 
data and ensure cross-compatibility of the results) 

# Model scenarios

Once the input data has been processed and sub-setted to the area of interest,
it is passed to a regression model. The dependent variable is the 'observed'
level of cycling from the flow data (*olc*); the explanatory variables include
the distance between origin and destination and a series of other flow and
zone-level attributes. By aggregating the origins of all flows,
the model also estimates the rate
of cycling among inhabitants. (Aggregating by destination would also allow
an estimate of the number incoming cyclists per work destination.)
In roughly descending order of importance
(this will be context-dependent) and model implementation these are:

- Distance between origins and destinations. This was calculated in the first
instance as Euclidean (straight line) distance and subsequently refined to an
estimate of route distance using the CycleStreets.net API.

- Hilliness

- Gender balance. The remit for including this variable is that the male:female
ratio of cycle commuters is around 3:1 in the 
UK;^[The mean proportion of males cycling to work from the 2011 Census
across Local Authorities
in England is 0.77. This corresponds to a ratio of 3.3:1.]
thus including the
proportion of short (5km and less) trips made by females can
greatly improve model fit. Note that this variable was used at the areal
unit level (per zone, as opposed to per origin-destination pair) due to
data limitations. Critically, this variable can be used as the basis of 
scenarios estimating the impact of a 'gender equality' scenario for cycling
increase at the local level.

- Age. 

Note that *total number of trips* is not an explanatory variable. This is because
the dependent variable is not the absolute number of cyclists, but a proportion
of trips made that are expected to be made by bike.

## Baseline

## Cycling Delivery Plan

The Cycling Delivery Plan scenario (*cdp*) is based on the UK Government's 
target to double cycling, from 0.8 billion stages currently to
1.6 billion stages by 2025. Assuming increases in population are roughly
offset by a continuation in the trend towards lower trip
rates,^[Increases
in population would mean the *proportion* of trips by bicycle
would not need to double for the *absolute number* of trips to double.
However, the rate of trips overall (measured in the number of trips
per person per year by any mode for any purpose) is on a long-term
downward trajectory which more than offsets the impact of population
growth. See
Crawford and Lovelace (2015) for a detailed discussion of this issue.
The authors could not find evidence about how this trend was
accounted for by the DfT in scenarios from the National Transport
Moel (NTM) or elsewhere.]
the *cdp* doubles the value of the distance decay curve
predicted in *base* for all distances.

Note that this does not necesarily
result in a doubling in cycling. If the local rate of cycling in the
study area is unexpectedly high given the distance decay curve in the
model, the rate of cycling will less than double.
The *cdp* scenario also relates to the *distribution* of trips
in the study area compared with the data used for the model.
If the distribution of
all trips in the regression model
is flatter than the distribution of cycling trips in the study area,
a doubling in
propensity will not lead to a doubling in cycling. If, on the other hand,
the distribution of cycling trips in the study area mirrors high
volume flows for which cycling is currently rare,  a doubling in propensity
will more-than-double the rate of cycling. If the study flows are the same
as the data used to train the model, *cpd* always results in a doubling in
cycling. These concepts are illustrated in
Fig. x below.

```{r, echo=FALSE, warning=FALSE, fig.cap="The rate of cycling under the cpd scenario for a case study Local Authority (Coventry). OLC is represented in blue, SLC(cdp) is represented by the white lines."}
l <- readRDS("../pct-data/coventry/l.Rds")
flow <- l@data
mod_logsqr <- glm(clc ~ dist + I(dist^0.5), data = flow, weights = All, family = "quasipoisson")
flow$fitted <- mod_logsqr$fitted.values * flow$All
coefs <- coef(mod_logsqr)
ff <- stplanr::dd_logsqrt(x = flow$dist, a = exp(coefs[1]), b1 = coefs[2], b2 = coefs[3]) 
# plot(ff, mod_logsqr$fitted.values) # perfect fit - function works
flow$cdp <- ff * 2 * flow$All

l2 <- rep(l$dist, l$All)
l3 <- rep(l$dist, l$Bicycle)
l4 <- rep(flow$dist, flow$cdp)
# hist(l2)
p2 <- ggplot() + geom_histogram(aes(l2), binwidth = 0.5) +
  geom_histogram(aes(l3), binwidth = 0.5, fill = "blue") +
  geom_histogram(aes(l4), binwidth = 0.5, col = "white", fill = NA, linewidth = 5) +
  scale_y_log10() + xlab("Distance (km)")

p1 <- ggplot() + geom_histogram(aes(l2), binwidth = 0.5) +
  geom_histogram(aes(l3), binwidth = 0.5, fill = "blue") +
  geom_histogram(aes(l4), binwidth = 0.5, col = "white", fill = NA, linewidth = 5) + coord_cartesian(ylim = c(0, 2000)) + xlab("Distance (km)")

library(gridExtra)
grid.arrange(p1, p2)
```



## Gender equality

The Gender Equality scenario (*gendereq*) is a relatively simple modification of
an existing scenario. For the purposes of explanation, we will
use the *observed level of cycling* (*OLC*) as the basis of the
scenario. However, it is possible to apply the *gendereq* method to
any scenario, as described towards the end of this section.

While the Baseline and Cycling Delivery Plan scenarios
(*base* and *cpd* respectively) assume that the local
gender split in cycling continues (typically, around 3/4 of cycle commuters
are males, although this varies over geographic space), *gendereq*
assumes that females become as likely to cycle as males are, for a given
origin-destination pair (per *flow*).
A prerequisite is a model-based estimate of the number of male
and female cyclists between origin and destinations for the baseline scenario.
This involves splitting the number of cyclists project by the model, 
the *Scenario-based Level of Cycling*, into
male ($SLC_m$) and female ($SLC_f$) components:

$$
SLC = SLC_m + SLC_f
$$

More males cycle than females in every Local Authority in the country
(Figure x). For this reason, the *gendereq* scenario
is based on the assumption that the rate of cycling amongst
females increases to match the rate of cycling amongst males, rather than vice
versa. Under *gendereq* $SLC_m$ remains constant. The challenge is to
find the value of $SLC_f$ 
such that the proportion 
of females cycling becomes equal to the proportion of males cycling
($pfemale(gendereq)_c = pmale_c$). 
Note that this is not as simple as $SLC_f = SLC_m$: the gender split
of the overall rate of flow must be taken into
account.^[To
illustrate this point, consider a flow in which there
are are many more female travellers than males.
$SLC_f$ may rise above $SLC_m$ in this case.
] It is the *proportion* of males  and females
per flow who cycle that becomes equal ($pcycle(gendereq)_f = pcycle_m$).
From this the updated value of $SLC_f$ can be calculated from the total
number of females travelling along the flow line ($tflow_f$):

$$
SLC(gendereq)_f = pcycle_m * tflow_f
$$

```{r, echo=FALSE, fig.cap="Cycling and the gender balance of cycling in England. The choropleth maps illustrate the spatial distribution of the two variables. The scatter plot illustrates the relationship between the two variables cycle commuting (x axis) against the proportion of commuter cyclists who are male (y axis) for all 326 Local Authorities (including Districts) in the UK."}
grid.raster(readPNG("/home/robin/Dropbox/DfT bid/figures/las-gender-pcycle.png"))
```

Key to the *gendereq* scenario is therefore estimating $pcycle_m$:
the proportion of males for any given flow who cycle.
For each flow, we use the following variables to calculate change in
the number of female cyclists:

- The total number of flows by all modes ($tflow$) and by bicycle ($olc$) per flow.
- The dominance of males amongst commuter cyclists per zone, expressed as an
estimate of the proportion of cycling by males ($pcycle(z)_m$).
- The male/female ratio of the travel-to-work flow in question, represented by
the proportion of all trips between origin and destination by males ($ptrips_m$).

Note that because cyclists are male or female, $ptrips_f = 1 - ptrips_m$ 
Based on this data, the proportion of males
(and females in *gendereq*) per flow who cycle is assumed to
be equal to the proportion who cycle at the zone level

$$
pcycle_{m} = pcycle(gendereq)_f = pcycle(z)_m
$$

From this the estimate of the updated number of female cyclists is simple
to calculate:

$$
SLC(gendereq)_f = pcycle(z)_m * tflow * ptrips_f
$$

To illustrate how this method works in practice, imagine a flow in which
5 from a total of 50 people commute by bicycle ($tflow = 50; olc = 5$).
60% of the flow is constituted made by males
($ptrips_m = 0.6$) and 75% of commuter
cycling in the zone is by males ($pcycle(z)_m = 0.75$).
The first stage is to break $tflow$ down into male and female constituents,
of 30 and 20, respectively:

$$
tflow_m = tflow * ptrips_m; tflow_f = tflow * (1 - ptrips_m)
$$

Next we estimate the number of male cyclists to be 3.75 (5 * 0.75):

$$
olc_m = olc * pcycle(z)_m
$$

From the two previous equations we calculate that the proportion of
males who cycle is 0.125 (3.75 / 30):

$$
pmale_c = olc_m / tflow_m
$$

The new rate of female cycling can then be calculated by setting the proportion
of females who cycle equal to $pmale_c$, as 2.5 (20 * 0.125):

$$
slc(gendereq)_f = tflow_f * pmale_c
$$

Finally the new overall rate of cycling is calculated as 6.25 (3.75 + 2.5):

$$
slc(gendereq) = olc_m + slc(gendereq)_f
$$

```{r, echo=FALSE}
tflow <- 50
olc <- 5 #  the currect rate of cycling between origin (o) and destination (d)
ptrips_m <- 0.6 # the proportion of all trips o and d by males
pcyclez_m <- 0.75 # the proportion of cycle trips in the zone/region made by males
tflow_m <- tflow * ptrips_m 
tflow_f <- tflow * (1 - ptrips_m) 
olc_m <- olc * pcyclez_m
olc_f <- olc - olc_m
pmale_c <- olc_m / tflow_m 
slc_gendereq_f <- tflow_f * pmale_c
# print(olc_f)
# print(slc_gendereq_f)
```

The increase to 6.25 cyclists from 5 in the *gendereq* scenario represents
an increase
of 25% from the base scenario. To verify that the numbers make sense,
check if `olc_m / tflow_m` is equal to `slc_gendereq_f / tflow_f`.
The answer is 12.5% in both cases. Gender equality in cycling has been reached.
Note that that $SLC(gendereq)$ can be calculated based on any scenario.
In our model, instead of using the conservative *baseline* scenario,
we estimate $SLC(gendereq)$ based on the Cycling Delivery Plan
($cdp$) scenario.

## Go Dutch

## Electric bicycles

# Results

# Discussion

The flexibility of the approach outlined in this paper ensures that the
method can be used in many different contexts. Because the underlying
methods and computation are transparent and open source, it is
possible to harness them in many different ways. This flexibility
has been demonstrated by the tool's ability to be deployed in any
Local Authority in England, for a range of cycling scenarios, with
the results presented in a range of ways. However, the flexibility
of the approach would allow it to be used in contexts that go well
beyond re-running the model for different cities in the same country.
Potential extensions of the model include:

- Deployment of the tool and underlying flow model in different
countries.^[This would depend on having ]

# Appendix: Using the tool

This Appendix summarises the work from the perspective of practitioners
by describing how the NPCT may be used to inform the decision-making process.

# References
