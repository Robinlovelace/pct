---
title: Where to build bike paths? A generalisable flow-level model of cycling uptake
  for sustainable transport planning
author: "Robin Lovelace"
date: "April 12, 2015"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  word_document: default
bibliography: ~/Documents/Transport.bib
---

```{r, echo=FALSE, include=FALSE}
pkgs <- c("stplanr", "knitr", "xtable", "sp")
vapply(pkgs, require, character.only = T, FUN.VALUE = logical(1))
```


# Introduction

# Data

The basic model requires only two sets of input data
(although more refined versions benefit from many additional datasets):

- *Flow data* estimating the rate of movement between different places,
often recorded through Census travel to work questions. The data is
generally provided as a 'flow matrix' (with rows representing origins
and columns destinations) or a longer table of origin-destination pairs.
This type of data is increasingly available from so-called 'Big Data'
sources such as passively collected mobile telephone records.
- *Geographical data* on the coordinates of trip origins and destinations.
As a bare minimum, this means the (preferably population-weighted)
centroids of each zone in the study area but could also include.

The flow model described in this paper can work for
anywhere that has access to these two data types. To link
the two datasets together, *zone ids* are needed in both
datasets. To ease the process of combining *flow* and *point* data,
an R function called `gFlow2Lines()` was 
created.^[The source code of `gFlow2Lines()` has been made available
online, as part of an R package for sustainable transport planning,
**stplanr**. See [github.com/Robinlovelace/stplanr/](https://github.com/Robinlovelace/stplanr/blob/master/R/gFlow.R).]
The two input datasets and single output, a set of geographically defined
lines with attributes for each flow in both directions
(which we label `flowlines`) are illustrated in the tables (1 and 2)
and figure (1) below.

```{r tflow, echo=FALSE, results='asis'}
t1 <- xtable(head(flow[c(1:3, 12)]), caption = "Sample of the 'flow' input dataset, representing the number of people who commute from locations within and between administrative zones (MSOAs)", label = "tbl:flow")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r tcents, echo=FALSE, results='asis'}
t2 <- xtable(as.data.frame(cents[1:3,-c(3,4)]), caption = "Sample of the 'cents' input dataset, representing the geographical location of the population-weighted centroids of MSOA zones described in Table~\\ref{tbl:flow}", label = "tbl:cents")
print(t1, type = "latex", comment = FALSE, caption.placement = "top")
```

```{r, echo=FALSE, fig.cap="Illustration of 'flow data' converted into geographical lines between origin and destination pairs. Width represents the total number of trips. Note the circles, which represent intra-zone flow."}
data("flowlines")
plot(flowlines, lwd = flowlines$All / 10)
```


Although the details may differ (e.g. the categories used to disaggregate flow
by vehicle mode, trip type and socio-demographic group), the basic structure
of flow data will be the same the world over.
The model for England described in this paper used the following open datasets:

- `wu03ew_v2.csv`, a 104 MB (12 MB compressed) comma-delimited
(human readable text) file
of flows between unique origin destination pairs, disaggregated by mode (see Table \ref{tbl:flow}). Note that this is a square table, usually loaded as a `data.frame`
in R. Note the origin and destination codes in the top row of table \ref{tbl:flow}
are the same, indicating *intra-zone* flow.
- `cents.geojson`, representing populations-weighted centroids of local
administrative zones (MSOAs). These are loaded in the model from
a small (1.7 MB) human-readable text file stored in the open
data format GeoJSON. This file was originally downloaded as a Shapefile
under the UK's Open Government Licence.^[The license was accessed from http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/ in
March 2015.]

## Loading data for local government areas

To ensure reproducibility and enable deployment of the model outside the
original case study area of Manchester, a systematic data loading method was
developed. The computational work to load the various datasets is contained
in the folder `loading-data` in the project's central repository.^[See https://github.com/npct/pct/tree/master/loading-data]. 
In the UK, local transport decisions (such as the location of new cycle paths)
are often made at the Local Authoritority level [@Gaffron2003].
 some work to debug the 
data and ensure cross-compatibility of the results) 

# Model scenarios

Once the input data has been processesed and sub-setted to the area of interest,
it is passed to a regression model that estimates what the rate of cycling
*should* be between OD pairs (and hence within local areas via aggregration) based
on a series of explanatory variables. In roughly descending order of importance
(this will be context-dependent) and model implementation these are:

- Distance between origins and destinations. This was calculated in the first
instance as Euclidean (straight line) distance and subsequently refined to an
estimate of route distance using the CycleStreets.net API.

- Hilliness

- Gender balance. The remit for including this variable is that the male:female
ratio of cycle commuters is around 4:1 in the UK; thus including the
proportion of short (5km and less) trips made by females can
greatly improve model fit. Note that this variable was used at the areal
unit level (per zone, as opposed to per origin-destination pair) due to
data limitations. Critically, this variable can be used as the basis of 
scenarios estimating the impact of a 'gender equality' scenario for cycling
increase at the local level.

- Age. 

Note that *total number of trips* is not an explanatory variable. This is because
the dependent variable is not the absolute number of cyclists, but a proportion
of trips made that are expected to be made by bike.

## Baseline


## Gender equality

The Gender Equality scenario (*gendereq*) is a relatively simple modification of
an existing scenario. For the purposes of explanation, we will
use the *observed level of cycling* (*OLC*) as the basis of the
scenario. However, it is possible to apply the *gendereq* method to
any scenario, as described towards the end of this section.

While the Baseline and Cycling Delivery Plan scenarios
(*base* and *cpd* respectively) assume that the local
gender split in cycling continues (typically, around 3/4 of cycle commuters
are males, although this varies over geographic space), *gendereq*
assumes that females become as likely to cycle as males are, for a given
origin-destination pair (per *flow*).
A prerequisite is a model-based estimate of the number of male
and female cyclists between origin and destinations for the baseline scenario.
This involves splitting the number of cyclists project by the model, 
the *Scenario-based Level of Cycling*, into
male ($SLC_m$) and female ($SLC_f$) components:

$$
SLC = SLC_m + SLC_f
$$

In the Gender Equality ($gendereq$) scenario
$SLC_m$ remains constant. $SLC_f$ changes, however, such that the proportion
of males cycling is equal to the proportion (or the probability)
of females cycling per flow
($pfemale(gendereq)_c = pmale_c$). 
Note that this is not as simple as setting $SLC_f = SLC_f$: the gender split
of the overall rate of flow must be taken into
account.^[To
illustrate this point, consider a flow in which there
are no female travellers. $SLC_f$ cannot possibly be positive in this case
because no females make the trip by any mode, so cannot switch to cycling.
]
Thus the *gendereq* scenario can be reduced to calculating $pcycle_m$:
the proportion of males for any give flow who make the trip by bicycle.
For each OD flow, we use the following variables to estimate the increase in female
propensity resulting from women being as likely to cycle as men per OD pair:

- The dominance of males amongst commuter cyclists per zone, expressed as an
estimate of the proportion of cycling by males ($pcycle(z)_m$).
- The male/female ratio of the travel-to-work flow in question, represented by
the proportion of all trips between origin and destination by males ($ptrips_m$).

Based on this data, the proportion of males per flow who cycle can be
calculated as follow:

$$
pmale_{c} = \frac{olc_m}{tflow * ptrips_m} 
$$

where

$$
olc_m = olc * pcycle_m
$$

and 

$$
pcycle_m = \frac{ptrips_m * pcycle(z)_m}{1 - ptrips_m * pcycle(z)_m  }
$$

To illustrate how this scenario works, imagine a scenario in which
5 from a total of 50 people commute by bicycle between zone i and j.
60% of the commutes overall between i and j are made by males and 75% of commuter
cycling in the zone is by males. This can be described in the language of R
as follows:

```{r}
tflow <- 50
olc <- 5 #  the currect rate of cycling between origin (o) and destination (d)
ptrips_m <- 0.6 # the proportion of all trips o and d by males
pcyclez_m <- 0.75 # the proportion of cycle trips in the zone/region made by males
pcycle_m <- ptrips_m * pcyclez_m / (1 - ptrips_m * pcyclez_m)
olc_m <- olc * pcycle_m
pmale_c <- olc_m / (tflow * ptrips_m)
```

We can verify this by calculating the number of female cyclists per flow
($olc_f$). In theory, $olc_m + olc_f$ should equal $olc$, set to 5 in this
hypothetical example:

```{r}
pcycle_f <- 1 - pcycle_m
olc_f <- olc * pcycle_f
pfemale_c <- olc_f / (tflow * (1 - ptrips_m))
print(pfemale_c)
print(olc_m)
print(olc_f)
olc_m + olc_f
```

SLC in the *gendereq* scenario ($SLC(gendereq)$) can then
be derived as follows:

$$
pfemale(gendereq)_c = pmale_c
$$

$$
slc(gendereq)_f = pfemale_c tflow_f
$$

Based on the above example, $SLC(gendereq)$
scenario would be 6.8 cyclists, up from 5 cyclists in OLC.
This represents an increase of just over 1/3 in the rate of cycling, for a 
reasonably typical example.

```{r}
pfemale_gendereq_c <- pmale_c
slc_gendereq_f <- pfemale_gendereq_c * (tflow * (1 - ptrips_m))
olc_m + slc_gendereq_f
```

Note that that $SLC(gendereq)$ can be calculated based on any scenario.
In our model, we estimate $SLC(gendereq)$ based on the Cycling Delivery Plan
($cdp$) scenario.


## Go Dutch

## Electric bicycles

# Results

# Discussion

The flexibility of the approach outlined in this paper ensures that the
method can be used in many different contexts. Because the underlying
methods and computation are transparent and open source, it is
possible to harness them in many different ways. This flexibility
has been demonstrated by the tool's ability to be deployed in any
Local Authority in England, for a range of cycling scenarios, with
the results presented in a range of ways. However, the flexibility
of the approach would allow it to be used in contexts that go well
beyond re-running the model for different cities in the same country.
Potential extensions of the model include:

- Deployment of the tool and underlying flow model in different
countries.^[This would depend on having ]

# Appendix: Using the tool

This Appendix summarises the work from the perspective of practitioners
by describing how the NPCT may be used to inform the decision-making process.

# References
